<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI PR Reviewer</title>
    <style>
        :root { 
            --primary-color: rgb(106, 8, 162);;
            --primary-dark: #1d4ed8;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --critical-color: #dc2626;
            --background: #ffe7fc;
            --surface: #d0449d;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #911ebe;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .main-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow);
            border: 5px solid var(--border);
        }

        .platform-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            background: var(--background);
            padding: 0.25rem;
            border-radius: 8px;
        }

        .platform-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            color: var(--text-primary);
            position: relative;
        }

        .platform-tab:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .platform-tab.active {
            background: var(--primary-color);
            color: white;
        }
        .platform-tab:hover:not(.active) {
            background: rgb(106, 8, 162);
            color:white
        }

        .demo-section {
            margin-bottom: 1.5rem;
        }

        .demo-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .demo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        .demo-btn {
            padding: 0.75rem;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            text-align: left;
            transition: all 0.2s;
            color: var(--text-primary);
        }

        .demo-btn:hover {
            border-color: var(--primary-color);
            background: white;
            transform: translateY(-1px);
        }

        .demo-btn:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .demo-btn:active {
            transform: translateY(0);
        }

        .form-grid {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 200px;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .form-input, .form-textarea, .form-select {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
            background: white;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        }

        .code-textarea {
            min-height: 200px;
        }

        .analyze-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin: 0 auto;
            font-size: 1rem;
        }

        .analyze-btn:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .analyze-btn:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .analyze-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .results {
            margin-top: 2rem;
            display: none;
        }

        .summary-card {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .summary-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .score-display {
            text-align: center;
        }

        .score-number {
            font-size: 2rem;
            font-weight: 700;
        }

        .score-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .summary-badges {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .badge.critical { background: rgba(239, 68, 68, 0.2); color: var(--critical-color); }
        .badge.high { background: rgba(245, 158, 11, 0.2); color: var(--warning-color); }
        .badge.medium { background: rgba(59, 130, 246, 0.2); color: var(--primary-color); }
        .badge.low { background: rgba(16, 185, 129, 0.2); color: var(--success-color); }

        .issues-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .issue-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid;
            transition: transform 0.2s;
        }

        .issue-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .issue-card.critical { border-left-color: var(--critical-color); }
        .issue-card.high { border-left-color: var(--warning-color); }
        .issue-card.medium { border-left-color: var(--primary-color); }
        .issue-card.low { border-left-color: var(--success-color); }

        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .issue-title {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .issue-meta {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-shrink: 0;
        }

        .issue-description {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .code-block {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.85rem;
            margin: 1rem 0;
            overflow-x: auto;
            position: relative;
        }

        .suggestion {
            background: var(--background);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .suggestion-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .no-issues {
            text-align: center;
            padding: 2rem;
            color: var(--success-color);
        }

        .no-issues-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .platform-content {
            display: none;
        }

        .platform-content.active {
            display: block;
        }

        .platform-info {
            background: var(--background);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-color);
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--critical-color);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .demo-grid {
                grid-template-columns: 1fr;
            }

            .issue-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .summary-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }

        .api-config {
            background: var(--background);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
            border: 1px solid var(--border);
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        .api-status.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .api-status.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
        }

        .api-status.info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary-color);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            min-width: 300px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        .rate-limit-info {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(59, 130, 246, 0.05);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ¤– AI PR Reviewer</h1>
            <p>Intelligent code analysis for pull requests with security, performance, and logic insights</p>
        </div>

        <div class="main-card">
            <!-- Platform Selection -->
            <div class="platform-tabs" role="tablist" aria-label="Select platform">
                <button 
                    class="platform-tab active" 
                    data-platform="github" 
                    role="tab" 
                    aria-selected="true"
                    aria-controls="github-panel"
                    id="github-tab"
                >
                    GitHub
                </button>
                <button 
                    class="platform-tab" 
                    data-platform="gitlab" 
                    role="tab" 
                    aria-selected="false"
                    aria-controls="gitlab-panel"
                    id="gitlab-tab"
                >
                    GitLab
                </button>
                <button 
                    class="platform-tab" 
                    data-platform="cli" 
                    role="tab" 
                    aria-selected="false"
                    aria-controls="cli-panel"
                    id="cli-tab"
                >
                    CLI Tool
                </button>
            </div>

            <!-- Platform-specific content -->
            <div id="github-panel" class="platform-content active" role="tabpanel" aria-labelledby="github-tab">
                <div class="platform-info">
                    <strong>GitHub Integration:</strong> Analyze pull requests directly from GitHub repositories with webhooks and API integration.
                </div>
                <div class="api-config">
                    <div class="form-group">
                        <label class="form-label" for="github-token">GitHub Personal Access Token (Optional)</label>
                        <input 
                            type="password" 
                            id="github-token" 
                            class="form-input" 
                            placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                            value=""
                        >
                        <small style="color: var(--text-secondary); font-size: 0.85rem;">
                            For accessing private repositories and higher rate limits
                        </small>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="github-repo">Repository (Optional)</label>
                        <input 
                            type="text" 
                            id="github-repo" 
                            class="form-input" 
                            placeholder="owner/repository-name"
                        >
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="github-pr">Pull Request Number (Optional)</label>
                        <input 
                            type="number" 
                            id="github-pr" 
                            class="form-input" 
                            placeholder="123"
                        >
                    </div>
                    <button class="demo-btn" onclick="fetchGitHubPR()" style="margin-top: 0.5rem;">
                        ðŸ“¥ Fetch PR from GitHub
                    </button>
                </div>
            </div>

            <div id="gitlab-panel" class="platform-content" role="tabpanel" aria-labelledby="gitlab-tab">
                <div class="platform-info">
                    <strong>GitLab Integration:</strong> Connect with GitLab merge requests using GitLab CI/CD pipelines and API endpoints.
                </div>
                <div class="api-config">
                    <div class="form-group">
                        <label class="form-label" for="gitlab-token">GitLab Access Token (Optional)</label>
                        <input 
                            type="password" 
                            id="gitlab-token" 
                            class="form-input" 
                            placeholder="glpat-xxxxxxxxxxxxxxxxxxxx"
                        >
                        <small style="color: var(--text-secondary); font-size: 0.85rem;">
                            For accessing private projects and API features
                        </small>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="gitlab-project">Project ID (Optional)</label>
                        <input 
                            type="text" 
                            id="gitlab-project" 
                            class="form-input" 
                            placeholder="12345 or owner/project-name"
                        >
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="gitlab-mr">Merge Request IID (Optional)</label>
                        <input 
                            type="number" 
                            id="gitlab-mr" 
                            class="form-input" 
                            placeholder="42"
                        >
                    </div>
                    <button class="demo-btn" onclick="fetchGitLabMR()" style="margin-top: 0.5rem;">
                        ðŸ“¥ Fetch MR from GitLab
                    </button>
                </div>
            </div>

            <div id="cli-panel" class="platform-content" role="tabpanel" aria-labelledby="cli-tab">
                <div class="platform-info">
                    <strong>CLI Tool:</strong> Use the command-line interface for local development and CI/CD integration.
                    <br><br>
                    <code>npm install -g ai-pr-reviewer</code><br>
                    <code>ai-pr-review --file changes.diff --format json</code>
                </div>
                <div class="api-config">
                    <div class="form-group">
                        <label class="form-label" for="ai-provider">AI Analysis Provider</label>
                        <select id="ai-provider" class="form-select">
                            <option value="local">Local Analysis (Default)</option>
                            <option value="openai">OpenAI GPT-4</option>
                            <option value="cohere">Cohere Command</option>
                            <option value="anthropic">Claude (Coming Soon)</option>
                        </select>
                    </div>
                    <div class="form-group" id="ai-token-group" style="display: none;">
                        <label class="form-label" for="ai-token">API Key</label>
                        <input 
                            type="password" 
                            id="ai-token" 
                            class="form-input" 
                            placeholder="Enter your API key"
                        >
                        <small style="color: var(--text-secondary); font-size: 0.85rem;">
                            Your API key is stored locally and never sent to our servers
                        </small>
                    </div>
                </div>
            </div>

            <!-- Demo Examples -->
            <div class="demo-section">
                <div class="demo-label">Quick Demo Examples:</div>
                <div class="demo-grid">
                    <button 
                        class="demo-btn" 
                        onclick="loadDemo('security')"
                        aria-label="Load security issues demo"
                    >
                        ðŸ”’ Security Issues<br>
                        <small>SQL injection, weak auth</small>
                    </button>
                    <button 
                        class="demo-btn" 
                        onclick="loadDemo('performance')"
                        aria-label="Load performance issues demo"
                    >
                        âš¡ Performance Issues<br>
                        <small>N+1 queries, inefficient loops</small>
                    </button>
                    <button 
                        class="demo-btn" 
                        onclick="loadDemo('logic')"
                        aria-label="Load logic errors demo"
                    >
                        ðŸ§  Logic Errors<br>
                        <small>Assignment vs comparison</small>
                    </button>
                    <button 
                        class="demo-btn" 
                        onclick="loadDemo('clean')"
                        aria-label="Load clean code demo"
                    >
                        âœ… Clean Code<br>
                        <small>Best practices example</small>
                    </button>
                </div>
            </div>

            <!-- Error message container -->
            <div id="error-message" class="error-message" role="alert" aria-live="polite"></div>

            <!-- Input Form -->
            <div class="form-grid">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="commitMessage">Commit Message</label>
                        <textarea 
                            id="commitMessage" 
                            class="form-textarea" 
                            placeholder="Describe your changes (e.g., feat: Add user authentication system)"
                            aria-describedby="commit-help"
                        ></textarea>
                        <small id="commit-help" class="sr-only">Enter a descriptive commit message for your changes</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="language">Programming Language</label>
                        <select id="language" class="form-select" aria-describedby="language-help">
                            <option value="javascript">JavaScript</option>
                            <option value="typescript">TypeScript</option>
                            <option value="python">Python</option>
                            <option value="java">Java</option>
                            <option value="csharp">C#</option>
                            <option value="php">PHP</option>
                            <option value="ruby">Ruby</option>
                            <option value="go">Go</option>
                            <option value="rust">Rust</option>
                            <option value="kotlin">Kotlin</option>
                            <option value="swift">Swift</option>
                            <option value="cpp">C++</option>
                        </select>
                        <small id="language-help" class="sr-only">Select the programming language of your code</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="codeChanges">Code Changes</label>
                    <textarea 
                        id="codeChanges" 
                        class="form-textarea code-textarea" 
                        placeholder="Paste your code diff, full code, or modified functions here..."
                        aria-describedby="code-help"
                    ></textarea>
                    <small id="code-help" class="sr-only">Paste the code you want to analyze for issues</small>
                </div>
            </div>

            <button class="analyze-btn" onclick="analyzeCode()" aria-describedby="analyze-help">
                <div class="spinner" aria-hidden="true"></div>
                <span>Analyze Pull Request</span>
            </button>
            <small id="analyze-help" class="sr-only">Click to start analyzing your code for security, performance, and logic issues</small>

            <!-- Results -->
            <div class="results" id="results" role="region" aria-label="Analysis results" aria-live="polite">
                <div class="summary-card" id="summary"></div>
                <div class="issues-list" id="issues"></div>
            </div>
        </div>
    </div>

    <script>
        let currentPlatform = 'github';
        let isAnalyzing = false;

        // API Configuration
        const API_CONFIG = {
            github: {
                baseUrl: 'https://api.github.com',
                token: localStorage.getItem('github_token') || ''
            },
            gitlab: {
                baseUrl: 'https://gitlab.com/api/v4',
                token: localStorage.getItem('gitlab_token') || ''
            },
            openai: {
                baseUrl: 'https://api.openai.com/v1',
                token: localStorage.getItem('openai_token') || ''
            },
            cohere: {
                baseUrl: 'https://api.cohere.ai/v1',
                token: localStorage.getItem('cohere_token') || ''
            }
        };

        // Initialize the application
        function initApp() {
            setupEventListeners();
            setupKeyboardNavigation();
        }

        function setupEventListeners() {
            console.log('Setting up event listeners');
            
            // Platform tabs - Add both click and focus handlers
            document.querySelectorAll('.platform-tab').forEach(tab => {
                // Remove any existing listeners first
                tab.removeEventListener('click', handleTabClick);
                tab.removeEventListener('keydown', handleTabKeydown);
                
                // Add new listeners
                tab.addEventListener('click', handleTabClick);
                tab.addEventListener('keydown', handleTabKeydown);
                
                console.log('Added listeners for tab:', tab.dataset.platform);
            });

            // Demo buttons
            document.querySelectorAll('.demo-btn').forEach(btn => {
                btn.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        btn.click();
                    }
                });
            });

            // Analyze button
            const analyzeBtn = document.querySelector('.analyze-btn');
            if (analyzeBtn) {
                analyzeBtn.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        if (!isAnalyzing) {
                            analyzeCode();
                        }
                    }
                });
            }

            // Save API tokens when they change
            ['github-token', 'gitlab-token', 'ai-token'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('change', function() {
                        if (this.value.trim()) {
                            const storageKey = id.replace('-', '_');
                            sessionStorage.setItem(storageKey, this.value.trim());
                            console.log('Saved token for:', storageKey);
                        }
                    });
                }
            });
            
            console.log('Event listeners setup complete');
        }

        function setupKeyboardNavigation() {
            // Tab navigation for platform tabs
            document.addEventListener('keydown', function(e) {
                const focusedElement = document.activeElement;
                
                if (focusedElement && focusedElement.classList.contains('platform-tab')) {
                    handleTabNavigation(e, focusedElement);
                }
            });
        }

        function handleTabClick(e) {
            console.log('Tab clicked:', e.currentTarget.dataset.platform);
            e.preventDefault();
            e.stopPropagation();
            const clickedTab = e.currentTarget;
            switchTab(clickedTab);
        }

        function handleTabKeydown(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                console.log('Tab activated with keyboard:', e.currentTarget.dataset.platform);
                e.preventDefault();
                e.stopPropagation();
                switchTab(e.currentTarget);
            }
        }

        function handleTabNavigation(e, currentTab) {
            const tabs = Array.from(document.querySelectorAll('.platform-tab'));
            const currentIndex = tabs.indexOf(currentTab);
            let nextIndex;

            switch (e.key) {
                case 'ArrowLeft':
                case 'ArrowUp':
                    e.preventDefault();
                    nextIndex = currentIndex > 0 ? currentIndex - 1 : tabs.length - 1;
                    break;
                case 'ArrowRight':
                case 'ArrowDown':
                    e.preventDefault();
                    nextIndex = currentIndex < tabs.length - 1 ? currentIndex + 1 : 0;
                    break;
                case 'Home':
                    e.preventDefault();
                    nextIndex = 0;
                    break;
                case 'End':
                    e.preventDefault();
                    nextIndex = tabs.length - 1;
                    break;
                default:
                    return;
            }

            tabs[nextIndex].focus();
            switchTab(tabs[nextIndex]);
        }

        function switchTab(targetTab) {
            console.log('Switching to tab:', targetTab.dataset.platform); // Debug log
            
            // Update tab states
            document.querySelectorAll('.platform-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
                tab.setAttribute('tabindex', '-1');
            });

            targetTab.classList.add('active');
            targetTab.setAttribute('aria-selected', 'true');
            targetTab.setAttribute('tabindex', '0');

            // Update current platform
            currentPlatform = targetTab.dataset.platform;
            console.log('Current platform set to:', currentPlatform); // Debug log

            // Show/hide platform content with forced display
            document.querySelectorAll('.platform-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });

            const targetPanel = document.getElementById(`${currentPlatform}-panel`);
            console.log('Target panel:', targetPanel); // Debug log
            
            if (targetPanel) {
                targetPanel.classList.add('active');
                targetPanel.style.display = 'block';
            }

            // Clear any previous error messages
            hideError();
            
            // Trigger any platform-specific initialization
            initializePlatformFeatures(currentPlatform);
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function hideError() {
            const errorDiv = document.getElementById('error-message');
            errorDiv.style.display = 'none';
        }

        // Enhanced demo data with more comprehensive examples
        const demos = {
            security: {
                commit: "feat: Add user authentication with session management",
                code: `// JavaScript - Security Issues Demo
app.post('/login', (req, res) => {
    const { username, password } = req.body;
    
    // SQL Injection vulnerability
    const query = \`SELECT * FROM users WHERE username = '\${username}' AND password = '\${password}'\`;
    
    db.query(query, (err, results) => {
        if (results.length > 0) {
            // Storing sensitive data in session
            req.session.password = password;
            req.session.user = results[0];
            
            // XSS vulnerability
            document.getElementById('welcome').innerHTML = 'Welcome ' + username;
            
            res.json({ success: true, user: results[0] });
        } else {
            res.status(401).json({ success: false });
        }
    });
});

// Weak JWT secret
const token = jwt.sign({ userId: user.id }, 'secret123');

// Code injection risk
const userCode = req.body.code;
eval(userCode); // Never do this!

// Command injection
const filename = req.body.filename;
exec(\`cat \${filename}\`, (error, stdout) => {
    res.send(stdout);
});`
            },
            performance: {
                commit: "perf: Optimize data loading and processing",
                code: `// JavaScript - Performance Issues Demo
async function loadUserDashboard(userId) {
    // N+1 Query Problem
    const user = await db.query('SELECT * FROM users WHERE id = ?', [userId]);
    
    // Sequential queries in loop
    for (let post of user.posts) {
        const postData = await db.query('SELECT * FROM posts WHERE id = ?', [post.id]);
        post.details = postData;
        
        // Nested N+1 problem
        for (let comment of post.comments) {
            const commentUser = await db.query('SELECT * FROM users WHERE id = ?', [comment.userId]);
            comment.user = commentUser;
        }
    }
    
    // Inefficient string concatenation
    let html = '';
    for (let i = 0; i < 1000; i++) {
        html += '<div>' + data[i] + '</div>';
    }
    
    // Object creation in loop
    const processors = [];
    for (let i = 0; i < items.length; i++) {
        const processor = new DataProcessor();
        processors.push(processor.process(items[i]));
    }
    
    // Inefficient timeout usage
    setTimeout(() => {
        updateCache(user);
    }, 0);
    
    return user;
}

// Memory leak potential
function createHandler() {
    const data = new Array(1000000).fill('data');
    return function() {
        console.log(data[0]); // Closure keeps entire array
    };
}`
            },
            logic: {
                commit: "fix: Update validation logic and error handling",
                code: `// JavaScript - Logic Errors Demo
function validateUserAccess(user, resource) {
    // Assignment instead of comparison
    if (user.role = 'admin') {
        return true;
    }
    
    // Incorrect operator precedence
    if (user.active && user.permissions.includes('read') || user.isGuest) {
        return true;
    }
    
    // Missing return statement
    if (user.isPremium) {
        console.log('Premium user detected');
        // Missing return true;
    }
    
    // Redundant boolean comparison
    if (user.verified === true && resource.public === false) {
        return false;
    }
    
    // Loose equality causing type coercion
    if (user.age == "18") {
        return allowAccess();
    }
    
    // Unreachable code
    return false;
    console.log('This will never execute');
    user.lastAccess = new Date();
}

// Missing await in async function
async function processData() {
    const data = fetchUserData(); // Missing await
    return data.process(); // This might fail
}

// Infinite loop potential
function findItem(items, target) {
    let i = 0;
    while (items[i] != target) { // Should use !== and check bounds
        i++;
    }
    return i;
}`
            },
            clean: {
                commit: "refactor: Implement secure user service with best practices",
                code: `// JavaScript - Clean Code Demo
const bcrypt = require('bcrypt');
const validator = require('validator');
const rateLimit = require('express-rate-limit');

/**
 * User service with security best practices
 */
class UserService {
    constructor(database, logger) {
        this.db = database;
        this.logger = logger;
        this.saltRounds = 12;
    }
    
    /**
     * Creates a new user with proper validation and security
     * @param {Object} userData - User data object
     * @returns {Promise<Object>} Created user object
     */
    async createUser(userData) {
        try {
            // Input validation with specific error messages
            const validation = await this.validateUserInput(userData);
            if (!validation.isValid) {
                throw new ValidationError(validation.errors);
            }
            
            // Check for existing user with parameterized query
            const existingUser = await this.db.query(
                'SELECT id FROM users WHERE email = ? OR username = ?',
                [userData.email, userData.username]
            );
            
            if (existingUser.length > 0) {
                throw new ConflictError('User already exists');
            }
            
            // Secure password hashing
            const hashedPassword = await bcrypt.hash(userData.password, this.saltRounds);
            
            // Transaction for data integrity
            const result = await this.db.transaction(async (trx) => {
                const user = await trx.query(
                    'INSERT INTO users (username, email, password_hash, created_at) VALUES (?, ?, ?, ?)',
                    [userData.username, userData.email, hashedPassword, new Date()]
                );
                
                await trx.query(
                    'INSERT INTO user_profiles (user_id, display_name) VALUES (?, ?)',
                    [user.insertId, userData.displayName || userData.username]
                );
                
                return user;
            });
            
            // Proper logging without sensitive data
            this.logger.info(\`User created successfully: \${userData.username}\`, {
                userId: result.insertId,
                timestamp: new Date().toISOString()
            });
            
            // Return sanitized user data
            return {
                id: result.insertId,
                username: userData.username,
                email: userData.email,
                createdAt: new Date()
            };
            
        } catch (error) {
            this.logger.error('User creation failed:', {
                error: error.message,
                stack: error.stack,
                userData: { username: userData.username, email: userData.email }
            });
            throw error;
        }
    }
    
    async validateUserInput(userData) {
        const errors = [];
        
        // Username validation
        if (!userData.username || userData.username.length < 3) {
            errors.push('Username must be at least 3 characters long');
        }
        
        if (!/^[a-zA-Z0-9_-]+$/.test(userData.username)) {
            errors.push('Username can only contain letters, numbers, underscores, and hyphens');
        }
        
        // Email validation
        if (!validator.isEmail(userData.email)) {
            errors.push('Please provide a valid email address');
        }
        
        // Password validation
        if (!this.isValidPassword(userData.password)) {
            errors.push('Password must be at least 8 characters with uppercase, lowercase, and numbers');
        }
        
        return {
            isValid: errors.length === 0,
            errors
        };
    }
    
    isValidPassword(password) {
        const minLength = 8;
        const hasUpperCase = /[A-Z]/.test(password);
        const hasLowerCase = /[a-z]/.test(password);
        const hasNumbers = /\d/.test(password);
        
        return password.length >= minLength && hasUpperCase && hasLowerCase && hasNumbers;
    }
}`
            }
        };

        function loadDemo(type) {
            try {
                const demo = demos[type];
                if (!demo) {
                    throw new Error(`Demo type "${type}" not found`);
                }
                
                document.getElementById('commitMessage').value = demo.commit;
                document.getElementById('codeChanges').value = demo.code;
                
                hideError();
                
                // Scroll to code input for better UX
                document.getElementById('codeChanges').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest' 
                });
                
                // Focus on the code textarea
                document.getElementById('codeChanges').focus();
                
            } catch (error) {
                showError(`Failed to load demo: ${error.message}`);
            }
        }

        async function analyzeCode() {
            if (isAnalyzing) {
                return;
            }

            const commitMessage = document.getElementById('commitMessage').value.trim();
            const codeChanges = document.getElementById('codeChanges').value.trim();
            const language = document.getElementById('language').value;

            // Enhanced validation
            if (!commitMessage) {
                showError('Please provide a commit message describing your changes');
                document.getElementById('commitMessage').focus();
                return;
            }

            if (!codeChanges) {
                showError('Please provide code changes to analyze');
                document.getElementById('codeChanges').focus();
                return;
            }

            if (commitMessage.length < 10) {
                showError('Commit message should be more descriptive (at least 10 characters)');
                document.getElementById('commitMessage').focus();
                return;
            }

            if (codeChanges.length < 50) {
                showError('Code changes seem too short. Please provide more substantial code for analysis');
                document.getElementById('codeChanges').focus();
                return;
            }

            hideError();
            
            // Show loading state
            isAnalyzing = true;
            const btn = document.querySelector('.analyze-btn');
            const spinner = btn.querySelector('.spinner');
            const span = btn.querySelector('span');
            
            btn.disabled = true;
            btn.setAttribute('aria-busy', 'true');
            spinner.style.display = 'block';
            span.textContent = 'Analyzing code...';

            // Simulate realistic analysis time based on code length
            const analysisTime = Math.min(Math.max(1500, codeChanges.length * 2), 4000);

            try {
                let analysis;
                
                // Use AI analysis if configured
                const aiProvider = document.getElementById('ai-provider');
                if (aiProvider && aiProvider.value !== 'local') {
                    analysis = await performAIAnalysis(codeChanges, language, commitMessage);
                } else {
                    // Simulate analysis time for local processing
                    await new Promise(resolve => setTimeout(resolve, analysisTime));
                    analysis = performAnalysis(commitMessage, codeChanges, language);
                }
                
                showResults(analysis);
                
            } catch (error) {
                showError(`Analysis failed: ${error.message}`);
            } finally {
                // Reset button state
                isAnalyzing = false;
                btn.disabled = false;
                btn.setAttribute('aria-busy', 'false');
                spinner.style.display = 'none';
                span.textContent = 'Analyze Pull Request';
            }
        }

        // Enhanced language-specific analysis patterns
        const languagePatterns = {
            javascript: {
                security: [
                    {
                        pattern: /SELECT.*FROM.*WHERE.*\$\{.*\}/gi,
                        severity: 'critical',
                        title: 'SQL Injection Vulnerability',
                        description: 'String interpolation in SQL queries allows injection attacks.',
                        suggestion: 'Use parameterized queries with placeholders (?, $1, etc.)',
                        score: -25
                    },
                    {
                        pattern: /innerHTML\s*=.*\+|innerHTML\s*=.*\$\{/gi,
                        severity: 'high',
                        title: 'XSS Vulnerability',
                        description: 'Dynamic innerHTML assignment can lead to cross-site scripting.',
                        suggestion: 'Use textContent, createElement, or sanitize HTML input.',
                        score: -20
                    },
                    {
                        pattern: /eval\s*\(/gi,
                        severity: 'critical',
                        title: 'Code Injection Risk',
                        description: 'eval() can execute arbitrary code and is a major security risk.',
                        suggestion: 'Avoid eval(). Use JSON.parse() for data or specific parsing methods.',
                        score: -30
                    },
                    {
                        pattern: /exec\s*\(.*\$\{|exec\s*\(.*\+/gi,
                        severity: 'critical',
                        title: 'Command Injection Risk',
                        description: 'Executing system commands with user input can be exploited.',
                        suggestion: 'Validate and sanitize all inputs, use safer alternatives.',
                        score: -30
                    }
                ],
                performance: [
                    {
                        pattern: /for.*\{[^}]*await.*query/gi,
                        severity: 'high',
                        title: 'N+1 Query Problem',
                        description: 'Database queries inside loops cause performance bottlenecks.',
                        suggestion: 'Use JOIN queries or batch operations to reduce database calls.',
                        score: -20
                    },
                    {
                        pattern: /setTimeout.*0\)|setImmediate/gi,
                        severity: 'medium',
                        title: 'Inefficient Async Pattern',
                        description: 'setTimeout(..., 0) is an anti-pattern for async operations.',
                        suggestion: 'Use Promise.resolve().then() or proper async/await patterns.',
                        score: -8
                    },
                    {
                        pattern: /for.*\{.*new\s+\w+\(/gi,
                        severity: 'medium',
                        title: 'Object Creation in Loop',
                        description: 'Creating objects repeatedly in loops affects performance.',
                        suggestion: 'Move object creation outside the loop or use object pooling.',
                        score: -10
                    }
                ],
                logic: [
                    {
                        pattern: /if\s*\([^)]*=\s*[^=]/gi,
                        severity: 'critical',
                        title: 'Assignment in Condition',
                        description: 'Assignment operator (=) used instead of comparison (===).',
                        suggestion: 'Use === for strict equality or == for loose equality.',
                        score: -25
                    },
                    {
                        pattern: /[^=!]==[^=]/gi,
                        severity: 'medium',
                        title: 'Loose Equality Comparison',
                        description: 'Using == can cause unexpected type coercion.',
                        suggestion: 'Use === for strict equality comparison.',
                        score: -8
                    },
                    {
                        pattern: /async.*function.*\{[^}]*(?!await)[^}]*fetch|async.*function.*\{[^}]*(?!await)[^}]*Promise\./gi,
                        severity: 'medium',
                        title: 'Missing await in Async Function',
                        description: 'Async function contains Promise without await.',
                        suggestion: 'Use await with Promise calls in async functions.',
                        score: -10
                    }
                ],
                quality: [
                    {
                        pattern: /\bvar\s+/gi,
                        severity: 'low',
                        title: 'Legacy Variable Declaration',
                        description: 'Using var can cause scope-related issues.',
                        suggestion: 'Use const for constants and let for mutable variables.',
                        score: -3
                    },
                    {
                        pattern: /console\.(log|error|warn|info)/gi,
                        severity: 'low',
                        title: 'Debug Console Statements',
                        description: 'Console statements should be removed from production code.',
                        suggestion: 'Use proper logging library or remove debug statements.',
                        score: -2
                    },
                    {
                        pattern: /const\s+\w+|let\s+\w+/gi,
                        severity: 'low',
                        title: 'Modern Variable Declarations',
                        description: 'Good use of modern const/let declarations.',
                        suggestion: 'Excellent! Continue using const and let.',
                        score: 2,
                        positive: true
                    }
                ]
            },
            python: {
                security: [
                    {
                        pattern: /f".*SELECT.*FROM.*\{.*\}"/gi,
                        severity: 'critical',
                        title: 'SQL Injection Vulnerability',
                        description: 'F-string formatting in SQL queries allows injection attacks.',
                        suggestion: 'Use parameterized queries with cursor.execute(sql, params).',
                        score: -25
                    },
                    {
                        pattern: /exec\s*\(|eval\s*\(/gi,
                        severity: 'critical',
                        title: 'Code Injection Risk',
                        description: 'exec() and eval() can execute arbitrary code.',
                        suggestion: 'Avoid exec/eval. Use ast.literal_eval for safe evaluation.',
                        score: -30
                    },
                    {
                        pattern: /pickle\.loads?\(.*input/gi,
                        severity: 'high',
                        title: 'Unsafe Deserialization',
                        description: 'Pickle can execute arbitrary code during deserialization.',
                        suggestion: 'Use JSON or implement custom serialization for untrusted data.',
                        score: -20
                    }
                ],
                performance: [
                    {
                        pattern: /for\s+\w+\s+in.*:\s*\n.*\.execute\(/gi,
                        severity: 'high',
                        title: 'Database Queries in Loop',
                        description: 'Multiple database queries in loops cause performance issues.',
                        suggestion: 'Use bulk operations or JOIN queries.',
                        score: -20
                    }
                ],
                logic: [
                    {
                        pattern: /except\s*:/gi,
                        severity: 'medium',
                        title: 'Bare Except Clause',
                        description: 'Catching all exceptions can hide important errors.',
                        suggestion: 'Catch specific exception types: except ValueError, TypeError:',
                        score: -10
                    }
                ],
                quality: [
                    {
                        pattern: /print\s*\(/gi,
                        severity: 'low',
                        title: 'Print Statements in Code',
                        description: 'Print statements should be replaced with proper logging.',
                        suggestion: 'Use logging module instead of print statements.',
                        score: -2
                    }
                ]
            }
        };

        function performAnalysis(commit, code, language) {
            const issues = [];
            let score = 85;

            try {
                // Get language-specific patterns
                const patterns = languagePatterns[language] || languagePatterns.javascript;

                // Apply all pattern categories
                ['security', 'performance', 'logic', 'quality'].forEach(category => {
                    if (patterns[category]) {
                        patterns[category].forEach(pattern => {
                            try {
                                const matches = [...code.matchAll(pattern.pattern)];
                                
                                matches.forEach(match => {
                                    const lineNum = getLineNumber(code, match.index);
                                    const codeSnippet = extractCodeSnippet(code, match[0]);
                                    
                                    issues.push({
                                        type: category.charAt(0).toUpperCase() + category.slice(1),
                                        severity: pattern.severity,
                                        title: pattern.title,
                                        description: pattern.description,
                                        line: lineNum,
                                        suggestion: pattern.suggestion,
                                        code: codeSnippet,
                                        positive: pattern.positive || false
                                    });

                                    score += pattern.score;
                                });
                            } catch (error) {
                                console.warn(`Pattern matching error for ${category}:`, error);
                            }
                        });
                    }
                });

                // Add complexity analysis
                const complexity = analyzeComplexity(code);
                score += complexity.score;
                if (complexity.issues.length > 0) {
                    issues.push(...complexity.issues);
                }

                // Language-specific enhancements
                const langAnalysis = getLanguageSpecificAnalysis(code, language);
                score += langAnalysis.scoreAdjustment;
                issues.push(...langAnalysis.issues);

                return {
                    score: Math.max(0, Math.min(100, score)),
                    issues: issues.sort((a, b) => getSeverityWeight(b.severity) - getSeverityWeight(a.severity)),
                    language,
                    platform: currentPlatform
                };
            } catch (error) {
                throw new Error(`Analysis failed: ${error.message}`);
            }
        }

        function getLineNumber(code, matchIndex) {
            if (typeof matchIndex !== 'number') {
                return 1;
            }
            return code.substring(0, matchIndex).split('\n').length;
        }

        function extractCodeSnippet(code, matchText) {
            if (!matchText) return 'Code snippet not available';
            
            if (matchText.length > 80) {
                return matchText.substring(0, 77) + '...';
            }
            return matchText;
        }

        function analyzeComplexity(code) {
            const issues = [];
            let score = 0;
            
            try {
                // Count cyclomatic complexity
                const complexityPatterns = [
                    /\bif\s*\(/gi, /\belse\s*if\s*\(/gi, /\bwhile\s*\(/gi, 
                    /\bfor\s*\(/gi, /\bswitch\s*\(/gi, /\bcase\s+.*:/gi,
                    /\bcatch\s*\(/gi, /&&|\|\|/gi
                ];
                
                let totalComplexity = 1; // Base complexity
                complexityPatterns.forEach(pattern => {
                    const matches = code.match(pattern);
                    if (matches) totalComplexity += matches.length;
                });

                // Analyze function length
                const lines = code.split('\n').filter(line => line.trim().length > 0);
                
                if (totalComplexity > 15) {
                    issues.push({
                        type: 'Quality',
                        severity: 'high',
                        title: 'High Cyclomatic Complexity',
                        description: `Function has cyclomatic complexity of ${totalComplexity} (threshold: 10).`,
                        line: 1,
                        suggestion: 'Break down into smaller, focused functions.',
                        code: `Complexity: ${totalComplexity}`
                    });
                    score -= 15;
                } else if (totalComplexity > 10) {
                    issues.push({
                        type: 'Quality',
                        severity: 'medium',
                        title: 'Moderate Complexity',
                        description: `Function complexity is ${totalComplexity}. Consider refactoring.`,
                        line: 1,
                        suggestion: 'Consider breaking into smaller functions.',
                        code: `Complexity: ${totalComplexity}`
                    });
                    score -= 8;
                }

                if (lines.length > 100) {
                    issues.push({
                        type: 'Quality',
                        severity: 'medium',
                        title: 'Very Long Function',
                        description: `Function has ${lines.length} lines (threshold: 50).`,
                        line: 1,
                        suggestion: 'Break into smaller, focused functions.',
                        code: `${lines.length} lines of code`
                    });
                    score -= 12;
                } else if (lines.length > 50) {
                    issues.push({
                        type: 'Quality',
                        severity: 'low',
                        title: 'Long Function',
                        description: `Function has ${lines.length} lines. Consider refactoring.`,
                        line: 1,
                        suggestion: 'Consider breaking into smaller functions.',
                        code: `${lines.length} lines of code`
                    });
                    score -= 5;
                }
            } catch (error) {
                console.warn('Complexity analysis error:', error);
            }

            return { issues, score };
        }

        function getLanguageSpecificAnalysis(code, language) {
            const issues = [];
            let scoreAdjustment = 0;

            try {
                // Additional language-specific checks
                switch (language) {
                    case 'javascript':
                    case 'typescript':
                        // Check for proper documentation
                        if (/\/\*\*[\s\S]*?\*\//.test(code)) {
                            issues.push({
                                type: 'Documentation',
                                severity: 'low',
                                title: 'Good Documentation',
                                description: 'Code includes JSDoc comments for better maintainability.',
                                line: getLineNumber(code, code.search(/\/\*\*/)),
                                suggestion: 'Excellent! Continue documenting your code.',
                                code: 'JSDoc comments found',
                                positive: true
                            });
                            scoreAdjustment += 3;
                        }
                        break;

                    case 'python':
                        // Check for proper docstrings
                        if (/def\s+\w+.*:\s*\n\s*""".*"""/gi.test(code)) {
                            issues.push({
                                type: 'Documentation',
                                severity: 'low',
                                title: 'Good Documentation',
                                description: 'Function has proper docstring documentation.',
                                line: getLineNumber(code, code.search(/def\s+\w+/gi)),
                                suggestion: 'Excellent! Continue documenting functions.',
                                code: 'Docstring present',
                                positive: true
                            });
                            scoreAdjustment += 3;
                        }
                        break;
                }
            } catch (error) {
                console.warn('Language-specific analysis error:', error);
            }

            return { issues, scoreAdjustment };
        }

        function getSeverityWeight(severity) {
            const weights = { critical: 4, high: 3, medium: 2, low: 1 };
            return weights[severity] || 0;
        }

        function showResults(analysis) {
            try {
                const resultsDiv = document.getElementById('results');
                const summaryDiv = document.getElementById('summary');
                const issuesDiv = document.getElementById('issues');

                // Summary
                const negativeIssues = analysis.issues.filter(i => !i.positive);
                const criticalCount = negativeIssues.filter(i => i.severity === 'critical').length;
                const highCount = negativeIssues.filter(i => i.severity === 'high').length;
                const mediumCount = negativeIssues.filter(i => i.severity === 'medium').length;
                const lowCount = negativeIssues.filter(i => i.severity === 'low').length;

                const riskLevel = analysis.score >= 80 ? 'Low Risk' : 
                                 analysis.score >= 60 ? 'Medium Risk' : 'High Risk';

                const scoreColor = analysis.score >= 80 ? 'var(--success-color)' : 
                                  analysis.score >= 60 ? 'var(--warning-color)' : 'var(--error-color)';

                summaryDiv.innerHTML = `
                    <div class="summary-header">
                        <div>
                            <div class="summary-title">Code Review Results</div>
                            <div style="margin-top: 0.5rem;">
                                <div><strong>Platform:</strong> ${analysis.platform.charAt(0).toUpperCase() + analysis.platform.slice(1)}</div>
                                <div><strong>Language:</strong> ${analysis.language.charAt(0).toUpperCase() + analysis.language.slice(1)}</div>
                                <div><strong>Risk Level:</strong> <span style="color: ${scoreColor};">${riskLevel}</span></div>
                                ${analysis.aiProvider ? `<div><strong>Analysis:</strong> ${analysis.aiProvider}</div>` : ''}
                            </div>
                        </div>
                        <div class="score-display">
                            <div class="score-number" style="color: ${scoreColor};">${analysis.score}</div>
                            <div class="score-label">out of 100</div>
                        </div>
                    </div>
                    ${negativeIssues.length > 0 ? `
                        <div class="summary-badges">
                            ${criticalCount > 0 ? `<div class="badge critical">ðŸš¨ ${criticalCount} Critical</div>` : ''}
                            ${highCount > 0 ? `<div class="badge high">âš ï¸ ${highCount} High</div>` : ''}
                            ${mediumCount > 0 ? `<div class="badge medium">âš¡ ${mediumCount} Medium</div>` : ''}
                            ${lowCount > 0 ? `<div class="badge low">â„¹ï¸ ${lowCount} Info</div>` : ''}
                        </div>
                    ` : ''}
                `;

                // Issues
                if (analysis.issues.length === 0 || negativeIssues.length === 0) {
                    issuesDiv.innerHTML = `
                        <div class="no-issues">
                            <div class="no-issues-icon">ðŸŽ‰</div>
                            <h3>No Issues Found!</h3>
                            <p>Your code looks clean and follows best practices.</p>
                        </div>
                    `;
                } else {
                    issuesDiv.innerHTML = negativeIssues.map(issue => {
                        const severityIcon = {
                            critical: 'ðŸš¨',
                            high: 'âš ï¸',
                            medium: 'âš¡',
                            low: 'â„¹ï¸'
                        }[issue.severity];

                        return `
                            <div class="issue-card ${issue.severity}">
                                <div class="issue-header">
                                    <div class="issue-title">${issue.title}</div>
                                    <div class="issue-meta">
                                        <div class="badge ${issue.severity}">
                                            ${severityIcon} ${issue.severity.charAt(0).toUpperCase() + issue.severity.slice(1)}
                                        </div>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            Line ${issue.line} â€¢ ${issue.type}
                                        </div>
                                    </div>
                                </div>
                                <div class="issue-description">${issue.description}</div>
                                <div class="code-block">${issue.code}</div>
                                <div class="suggestion">
                                    <div class="suggestion-title">ðŸ’¡ Suggestion</div>
                                    <div>${issue.suggestion}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // Show results and scroll to them
                resultsDiv.style.display = 'block';
                resultsDiv.scrollIntoView({ behavior: 'smooth' });
                
                // Add export functionality
                addExportButton();

            } catch (error) {
                showError(`Failed to display results: ${error.message}`);
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            
            // Force show the correct initial state
            document.querySelectorAll('.platform-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Show GitHub panel by default
            const githubPanel = document.getElementById('github-panel');
            if (githubPanel) {
                githubPanel.style.display = 'block';
                console.log('GitHub panel shown');
            }
            
            initApp();
            
            // Load saved API tokens
            const savedGitHubToken = sessionStorage.getItem('github_token');
            const savedGitLabToken = sessionStorage.getItem('gitlab_token');
            const savedAIToken = sessionStorage.getItem('ai_token');
            
            if (savedGitHubToken) {
                document.getElementById('github-token').value = savedGitHubToken;
            }
            if (savedGitLabToken) {
                document.getElementById('gitlab-token').value = savedGitLabToken;
            }
            if (savedAIToken) {
                document.getElementById('ai-token').value = savedAIToken;
            }
            
            // Initialize all platform features
            initializePlatformFeatures('github');
            initializePlatformFeatures('gitlab');
            initializePlatformFeatures('cli');
            
            // Add debug click handlers to test tab switching
            setTimeout(() => {
                console.log('Adding debug test...');
                const allTabs = document.querySelectorAll('.platform-tab');
                console.log('Found tabs:', allTabs.length);
                allTabs.forEach((tab, index) => {
                    console.log(`Tab ${index}: ${tab.dataset.platform}, Active: ${tab.classList.contains('active')}`);
                });
                
                // Test GitLab tab specifically
                const gitlabTab = document.querySelector('[data-platform="gitlab"]');
                const cliTab = document.querySelector('[data-platform="cli"]');
                console.log('GitLab tab found:', !!gitlabTab);
                console.log('CLI tab found:', !!cliTab);
                
                if (gitlabTab) {
                    gitlabTab.addEventListener('click', function() {
                        console.log('GitLab tab direct click handler triggered');
                    });
                }
                
                if (cliTab) {
                    cliTab.addEventListener('click', function() {
                        console.log('CLI tab direct click handler triggered');
                    });
                }
            }, 500);
        });

        // Check GitHub API rate limit
        async function checkGitHubRateLimit() {
            try {
                const token = document.getElementById('github-token').value.trim();
                const headers = {
                    'Accept': 'application/vnd.github.v3+json',
                    'User-Agent': 'AI-PR-Reviewer'
                };
                
                if (token) {
                    headers['Authorization'] = `token ${token}`;
                }

                const response = await fetch('https://api.github.com/rate_limit', { headers });
                
                if (response.ok) {
                    const data = await response.json();
                    const remaining = data.rate.remaining;
                    const resetTime = new Date(data.rate.reset * 1000);
                    
                    let rateLimitInfo = document.querySelector('#github-panel .rate-limit-info');
                    if (!rateLimitInfo) {
                        rateLimitInfo = document.createElement('div');
                        rateLimitInfo.className = 'rate-limit-info';
                        document.getElementById('github-panel').appendChild(rateLimitInfo);
                    }
                    
                    rateLimitInfo.innerHTML = `
                        <strong>GitHub API Status:</strong><br>
                        Remaining calls: ${remaining}/${data.rate.limit}<br>
                        Rate limit resets: ${resetTime.toLocaleTimeString()}<br>
                        ${token ? 'âœ… Authenticated' : 'âš ï¸ Unauthenticated (lower limits)'}
                    `;
                }
            } catch (error) {
                // Silently fail - rate limit check is not critical
                console.warn('Could not check GitHub rate limit:', error);
            }
        }

        // Export analysis results
        function exportResults(format = 'json') {
            const results = document.getElementById('results');
            if (results.style.display === 'none') {
                showError('No analysis results to export');
                return;
            }

            const analysisData = {
                timestamp: new Date().toISOString(),
                platform: currentPlatform,
                language: document.getElementById('language').value,
                commitMessage: document.getElementById('commitMessage').value,
                issues: Array.from(document.querySelectorAll('.issue-card')).map(card => {
                    return {
                        title: card.querySelector('.issue-title').textContent,
                        severity: card.className.split(' ').pop(),
                        description: card.querySelector('.issue-description').textContent,
                        suggestion: card.querySelector('.suggestion div:last-child').textContent,
                        code: card.querySelector('.code-block').textContent
                    };
                }),
                score: parseInt(document.querySelector('.score-number').textContent)
            };

            const blob = new Blob([JSON.stringify(analysisData, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pr-analysis-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAPIStatus('Analysis results exported successfully', 'success', `${currentPlatform}-panel`);
        }

        // Add export button functionality
        function addExportButton() {
            const resultsDiv = document.getElementById('results');
            if (resultsDiv && resultsDiv.style.display !== 'none') {
                let exportBtn = document.getElementById('export-btn');
                if (!exportBtn) {
                    exportBtn = document.createElement('button');
                    exportBtn.id = 'export-btn';
                    exportBtn.className = 'demo-btn';
                    exportBtn.style.marginTop = '1rem';
                    exportBtn.innerHTML = 'ðŸ’¾ Export Results';
                    exportBtn.onclick = () => exportResults();
                    resultsDiv.appendChild(exportBtn);
                }
            }
        }
    </script>
</body>
</html>
